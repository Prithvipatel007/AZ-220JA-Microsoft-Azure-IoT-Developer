---
lab:
    title: 'ラボ 16: Azure IoT Hub を使用した IoT デバイス管理の自動化'
    module: 'モジュール 8: デバイス管理'
---

# Azure IoT Hub を使用した IoT デバイス管理の自動化

IoT デバイスは、最適化されたオペレーティング システムを使用したり、シリコン上でコードを直接実行したりします (実際のオペレーティング システムは必要ありません)。このようなデバイスで実行されているソフトウェアを更新するために最も一般的な方法は、OSだけでなく実行されているアプリ (ファームウェアと呼ばれる) を含み、ソフトウェア パッケージ全体の新しいバージョンをフラッシュすることです。

各デバイスには特定の目的があるため、ファームウェアは非常に限定的で、デバイスの目的だけでなく、利用可能な制約されたリソースにも最適化されています。

ファームウェアの更新プロセスは、ハードウェアとハードウェアの製造元がボードを作成した方法に対して固有のプロセスにすることもできます。これは、ファームウェアの更新プロセスの一部が汎用的ではないことを意味し、ファームウェアの更新プロセスの詳細を取得するためにデバイスの製造元と協力する必要があります (ファームウェアの更新プロセスを知っている可能性が高い独自のハードウェアを開発している場合を除きます)。

ファームウェアの更新が個々のデバイスに手動で適用される場合、この方法では一般的な IoT ソリューションで使用されるデバイスの数を考慮することは意味がありません。現在、ファームウェアの更新は、クラウドからリモートで管理する新しいファームウェアの展開により、無線 (OTA) を介して実行することがより一般的になりました。

すべての無線を介した IoT デバイスのファームウェアの更新には、共通する一連の特徴があります。

1. ファームウェアのバージョンは、一意に識別されます
1. ファームウェアはバイナリ ファイル形式で提供されます。デバイスはこれをオンライン ソースから取得する必要があります
1. ローカルに保存されているファームウェアは、何らかの形の物理ストレージです (ROM メモリ、ハードドライブなど)
1. デバイスの製造元は、ファームウェアを更新するために必要なデバイスの操作の説明を提供します。

Azure IoT Hub は、単一のデバイスとデバイスのコレクションにデバイス管理操作を実装するための高度なサポートを提供します。[自動デバイス管理](https://docs.microsoft.com/azure/iot-hub/iot-hub-auto-device-config)機能を使用すると、一連の操作の構成、その操作のトリガー、進行状況の監視を簡単に行えます。

## ラボ シナリオ

Contoso 社のチーズ熟成庫に実装した自動空気処理システムは、同社が既に高い品質水準をさらに上げるのに役立ちました。同社は、チーズでこれまで以上に多くの賞を受賞しています。

基本ソリューションは、センサーと気候制御システムと統合された IoT デバイスで構成されており、マルチチャンバー貯蔵庫システム内の温度と湿度をリアルタイムで制御します。また、ダイレクト メソッドとデバイス ツイン プロパティの両方を使用してデバイスを管理する機能を示す、シンプルなバックエンド アプリを開発しました。

Contoso 社は、初期ソリューションからシンプルなバックエンド アプリを拡張し、オペレーターが蔵環境の監視とリモート管理に使用できるオンライン ポータルを含めています。新しいポータルでは、オペレーターはチーズの種類に基づいて、またはチーズの熟成プロセス内の特定の段階に合わせて蔵内の温度と湿度をカスタマイズすることさえできます。蔵内の各チャンバーまたはゾーンは、別々に制御することができます。

IT 部署は、オペレータ向けに開発したバックエンド ポータルを保守しますが、管理者はソリューションのデバイス側を管理することに同意しています。

この場合、これは次の 2 つのことを意味します。

1. Contoso 社の運用チームは、改善方法を常に模索しています。これらの機能強化の結果、デバイス ソフトウェアの新機能のリクエストが寄せられることがよくあります。

1. 洞窟の場所にデプロイされている IoT デバイスには、プライバシーを確保しハッカーがシステムを掌握するのを防ぐために、最新のセキュリティパッチが必要です。システムのセキュリティを維持するため、デバイスのファームウェアをリモートで更新して、デバイスを最新の状態に保つ必要があります。

自動デバイス管理とデバイス管理を大規模に行えるようにする IoT Hub の機能を実装する予定です。

次のリソースが作成されます。

![ラボ 16 アーキテクチャ](media/LAB_AK_16-architecture.png)

## このラボでは

このラボでは、次のタスクを正常に達成します。

* ラボの前提条件が満たされていることを確認する (必要な Azure リソースがあること)
* ファームウェアの更新を実装するシミュレートされたデバイスのコードを記述します
* Azure IoT Hub の自動デバイス管理を使用して、1 つのデバイスでファームウェアの更新プロセスをテストする

## ラボの手順

### 演習 1: ラボの前提条件を確認する

このラボでは、次の Azure リソースが利用可能であることを前提としています。

| リソースの種類 | リソース名 |
| :-- | :-- |
| リソース グループ | rg-az220 |
| IoT Hub | iot-az220-training-{your-id} |
| IoT デバイス | sensor-th-0155 |

これらのリソースを使用できるようにするには、次のタスクを完了してください。

1. 「**Azure にデプロイする**」を選択します。

    [Azure へのデプロイ](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fraw.githubusercontent.com%2FMicrosoftLearning%2FAZ-220-Microsoft-Azure-IoT-Developer%2Fbicep%2FAllfiles%2FARM%2Flab16.json)

1. メッセージが表示されたら、**Azure portal** にログインします。

    「**カスタム デプロイ**」ページが表示されます。

1. 「**サブスクリプション**」ドロップダウンの「**プロジェクトの詳細**」で、このコースで使用しようとしている Azure サブスクリプションが選択されていることを確認します。

1. 「**リソース グループ**」ドロップダウンで、「**rg-az220**」を選択します。

    > **注**: 「**rg-az220**」が表示されていない場合は、次の手順を行います。
    >
    > 1. 「**リソース グループ**」ドロップダウンで、「**新規作成**」をクリックします。
    > 1. 「**名前**」に「**rg-az220**」と入力します。
    > 1. 「**OK**」をクリックします。

1. 「**リージョン**」ドロップダウンの「**インスタンスの詳細**」で、最寄りのリージョンを選択します。

    > **注**: 「**rg-az220**」グループが既に存在している場合、「**リージョン**」 フィールドは、読み取り専用のリソース グループによって使用されるリージョンに設定されます。

1. 「**自分の ID**」フィールドに、演習 1 で作成した一意の ID を入力します。

1. 「**コース ID**」フィールドに、「**az220**」と入力します。

1. テンプレートを検証するには、「**確認および作成**」をクリックします。

1. 検証に合格したら、「**作成**」をクリックします。

    デプロイが開始します。

1. デプロイが完了したら、左側のナビゲーション エリアで、「**出力**」をクリックして、テンプレートからの出力値を確認します。

    後で使用する場合のために、出力をメモしておきます。

    * connectionString
    * deviceConnectionString
    * devicePrimaryKey

これで、リソースが作成されました。

### 演習 2: ファームウェアの更新を実装するシミュレートされたデバイスのコードを調べます

この演習では、デバイス ツインの必要なプロパティの変更を管理し、ファームウェアの更新をシミュレートするローカル プロセスをトリガーする簡単なシミュレートされたデバイスを確認します。ファームウェア更新を起動するために実装するプロセスは、実際のデバイスでファーム更新に使用されるプロセスと同様です。新しいファームウェア バージョンのダウンロード、ファームウェア更新のインストール、およびデバイスの再起動のプロセスがシミュレートされます。

Azure portal を使用して、デバイス　ツインのプロパティを使用してファームウェアの更新を構成および実行します。デバイス ツインのプロパティを使用して、構成変更要求をデバイスに転送し、進行状況を監視します。

#### タスク 1: デバイス シミュレーター アプリを調べる

このタスクでは、Visual Studio Code を使用して、新しいコンソール アプリを確認します。

1. **Visual Studio Code** を開きます。

1. 「**ファイル**」メニューで、「**フォルダーを開く**」を選択します。

1. 「フォルダーを開く」ダイアログで、ラボ 16 のスターター フォルダーに移動します。

    _ラボ 3: 開発環境の設定_: ZIP ファイルをダウンロードしてコンテンツをローカルに抽出することで、ラボ リソースを含む GitHub リポジトリを複製しました。抽出されたフォルダー構造には、次のフォルダー パスが含まれます。

    * すべてのファイル
      * ラボ
          * Azure IoT Hub を使用した 16 の IoT デバイス管理の自動化
            * スターター
              * FWUpdateDevice

1. 「**セットアップ**」、「**フォルダーの選択**」 の順にクリックします。

    Visual Studio Code のエクスプローラー ウィンドウに次のファイルが一覧表示されます。

    * FWUpdateDevice.csproj
    * Program.cs

1. 「**エクスプローラー**」ペインで、「**FWUpdateDevice.csproj**」ファイルをクリックして開き、参照されている NuGet パッケージを確認します。 

    * Microsoft.Azure.Devices.Client -Azure IoT Hub のデバイス SDK
    * Microsoft.Azure.Devices.Shared - Azure IoT デバイス とサービス SDK の共通コード
    * Newtonsoft.Json - Json.NET は、.NET 用の人気の高い高性能 JSON フレームワークです。

1. 「**エクスプローラー**」ペインで、「**Program.cs**」をクリックします。

#### タスク 2: アプリケーション コードを確認する

このタスクでは、IoT Hub で生成された要求に応答して、デバイスのファームウェア更新プログラムをシミュレートするためのコードを確認します。

1. **Program.cs **ファイルが Visual Studio Code で開かれていることを確認します。

1. `Global Variables` コメントを見つけます。

    この単純な例では、デバイスの接続文字列、デバイス ID、現在のファームウェア バージョンが追跡されます。

1. コード エディターに、次のコード行を見つけます。

    ```csharp
    private readonly static string deviceConnectionString = "<your device connection string>";
    ```

1. **\<your device connection string\>** を以前に保存したデバイス接続文字列に置き換えます。

    これが必要な唯一のコード変更です。

1. **Main** メソッドを見つけます。

    このメソッドは、先に使用したデバイス シミュレーターと同様に、IoT Hub などに接続するための **DeviceClient** インスタンスを作成するために **deviceConnectionString** を使用し、デバイスのツイン プロパティ変更コールバックを設定します。

    **InitDevice** メソッドは新しいもので、単にデバイスの起動サイクルをシミュレートし、**UpdateFWUpdateStatus** メソッドを介してデバイス ツインを更新することで、現在のファームウェアを報告します。

    その後、アプリはループし、ファームウェアの更新をトリガーするデバイス ツインの更新を待ちます。

1. **UpdateFWUpdateStatus** メソッドの定義を探し、コードを確認します。

    このメソッドでは、新しい **TwinCollection** インスタンスを作成し、提供された値を入力して、デバイス ツインを更新します。

1. **OnDesiredPropertyChanged** メソッドを探し、コードを確認します。

    このメソッドは、デバイス ツインの更新を受信したときにコールバックとして呼び出されます。ファームウェアの更新が検出された場合は、**UpdateFirmware** メソッドが呼び出されます。このメソッドは、ファームウェアのダウンロード、ファームウェアの更新、そしてデバイスの再起動をシミュレートするものです。

### 演習 3: 1 台のデバイスでのファームウェアの更新をテストする

この演習では、Azure portal を使用して新しいデバイス管理構成を作成し、それを単一のシミュレートされたデバイスに適用します。

#### タスク 1: デバイス シミュレーターを起動する

1. 必要に応じて **FWUpdateDevice** プロジェクトを Visual Studio Code で開きます。

1. 「ターミナル」ウィンドウが開いていることを確認します。

    コマンド プロンプトのフォルダーの場所は、`FWUpdateDevice` フォルダーです。

1. `FWUpdateDevice` アプリを実行するには、次のコマンドを入力します。

    ``` bash
    dotnet run "<device connection string>"
    ```

    > **注**: プレースホルダーを実際のデバイス接続文字列に置き換え、接続文字列の周囲に "" を必ず含めることに注意してください。
    >
    > 以下にその例を示します。`"HostName=iot-az220-training-{your-id}.azure-devices.net;DeviceId=sensor-th-0155;SharedAccessKey={}="`

1. 「ターミナル」ペインの内容を確認します。

    次のような出力がターミナルに表示されます。

    ``` bash
        sensor-th-0155: Device booted
        sensor-th-0155: Current firmware version: 1.0.0
    ```

#### タスク 2: デバイス管理構成を作成する

1. 必要に応じて、Azure アカウントの資格情報を使用して [Azure Portal](https://portal.azure.com/learn.docs.microsoft.com?azure-portal=true) にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントを使用してログインしていることを確認してください。

1. Azure portal ダッシュボードで、「**iot-az220-training-{your-id}**」をクリックします。

    IoT Hub ブレードが表示されるようになりました。

1. 左側のナビゲーション メニューの「**自動デバイス管理**」で 、「**IoT デバイスの構成**」をクリックします。

1. 「**IoT デバイスの構成**」ウィンドウで、「**+ デバイス構成の追加**」をクリックします。

1. 「**デバイス ツイン構成の作成**」ブレードの「**名前**」 で、**firmwareupdate** と入力します。

    「**ラベル** の下ではなく、構成に必要な「**名前**」フィールドに `firmwareupdate`と入力していることを確認 します。

1. ブレードの最下部で、「**次へ:**」をクリックします。**ツインズの設定 >**。

1. 「**デバイス ツインの設定**」で、「**デバイス ツインプロパティ**」 フィールドに **properties.desired.firmware** と入力します

1. 「**デバイス ツイン プロパティのコンテンツ**」フィールドに、次のように入力します。

    ``` json
    {
        "fwVersion":"1.0.1",
        "fwPackageURI":"https://MyPackage.uri",
        "fwPackageCheckValue":"1234"
    }
    ```

1. ブレードの最下部で、「**次へ:**」をクリックします。**メトリック >**。

    カスタム メトリックを使用して、ファームウェアの更新が有効であったかどうかを追跡します。

1. 「**メトリック**」タブの「**メトリック名**」で **fwupdated** と入力します

1. 「**メトリック基準**」で、次の項目を入力します。

    ``` SQL
    SELECT deviceId FROM devices
        WHERE properties.reported.firmware.currentFwVersion='1.0.1'
    ```

1. ブレードの最下部で、「**次へ:**」をクリックします。**ターゲット デバイス >**。

1. 「**ターゲット デバイス**」タブの「**優先度**」で、「**優先度(高い値..)**」 フィールドに 「**10**」と入力します。

1. 「**ターゲット条件**」の「**ターゲット条件**」フィールドに、次のクエリを入力します。

    ``` SQL
    deviceId='<your device id>'
    ```

    > **注**: `'<your device id>'` をデバイスの作成に使用したデバイス ID に置き換えてください。例: `'sensor-th-0155'`

1. ブレードの最下部で、「**次へ:**」をクリックします。**Review + create >**

    「**Review + create**」タブが開くと、新しい構成の 「検証に成功しました」というメッセージが表示されます。

1. 「**Review + create**」タブで、「検証が成功しました」というメッセージが表示されたら、「**作成**」をクリックします。

    「検証が成功しました」というメッセージが表示された場合は、設定を作成する前に、作業を確認する必要があります。

1. 「**IoT デバイスの構成**」ペインの 「**構成名**」に、新しい **firmwareupdat** の構成が一覧表示されていることを確認します。

    新しい構成が作成されると、IoT ハブは構成のターゲット デバイスの条件に一致するデバイスを探し、ファームウェアの更新構成を自動的に適用します。

1. 「Visual Studio Code」ウィンドウに切り替え、ターミナル ペインの内容を確認します。

    「ターミナル」ペインには、トリガーされたファームウェア更新プロセスの進行状況を一覧表示するアプリによって生成された新しい出力が含まれている必要があります。

1. シミュレートされたアプリを停止し、Visual Studio Code を閉じます。

    ターミナルの「Enter」キーを押すだけで、デバイス シミュレーターを停止できます。
