---
lab:
    title: 'ラボ 12: IoT Edge ゲートウェイを設定する'
    module: 'モジュール 6: Azure IoT Edge のデプロイプロセス'
---

# IoT Edge ゲートウェイを設定する

## ラボ シナリオ

このラボは理論に基づいた形で、IoT Edge デバイスをゲートウェイとして使用する方法について説明します。

ゲートウェイとして IoT Edge デバイスを使用するパターンは、透過、プロトコル変換、ID 変換の 3 つです。

**透過** – 理論的に IoT Hub に接続できるデバイスは、代わりにゲートウェイ デバイスに接続できます。ダウンストリーム デバイスは独自の IoT Hub ID を持ち、MQTT、AMQP、HTTP のいずれかのプロトコルを使用しています。ゲートウェイでは、デバイスと IoT Hub の間の通信を受け渡すだけです。デバイスはゲートウェイ経由でクラウドと通信していることを認識せず、IoT Hub のデバイスを操作しているユーザーは中間のゲートウェイ デバイスに気付きません。したがって、ゲートウェイは透過的です。「IoT Edge デバイスを透過ゲートウェイとして使用して透過ゲートウェイを作成する」を参照してください。

**プロトコルの変換**- 非透過なゲートウェイ パターンとしても知られる、MQTT、AMQP、または HTTP をサポートしないデバイスは、ゲートウェイ デバイスを代理として使用して IoT Hub にデータを送信できます。ゲートウェイは、ダウンストリーム デバイスによって使用されているプロトコルを認識し、IoT Hub で ID を持っている唯一のデバイスです。すべての情報は、1 つのデバイスつまりゲートウェイから送信されているように見えます。クラウド アプリケーションでデバイスごとにデータを分析する必要がある場合、ダウンストリーム デバイスではメッセージに追加の識別情報を埋め込む必要があります。また、ツインやメソッドなどの IoT Hub プリミティブは、ゲートウェイ デバイスでのみ使用でき、ダウンストリーム デバイスでは使用できません。

**ID の変換** -  IoT Hub に接続できないデバイスは、その代わりとして、ゲートウェイ デバイスに接続できます。ゲートウェイでは、ダウンストリーム デバイスに代わって、IoT Hub の ID とプロトコル変換が提供されます。ゲートウェイは十分にスマートであり、ダウンストリーム デバイスによって使用されているプロトコルの認識、ID の提供、IoT Hub プリミティブの変換などが行われます。ダウンストリーム デバイスは、ツインとメソッドが含まれるファーストクラスのデバイスとして IoT Hub に認識されます。ユーザーは、IoT Hub のデバイスと対話することができ、中間にゲートウェイ デバイスがあることには気付きません。

次のリソースが作成されます。

![ラボ 12 アーキテクチャ](media/LAB_AK_12-architecture.png)

## このラボでは

このラボでは、次のタスクを正常に達成します。

* ラボの前提条件が満たされていることを確認する (必要な Azure リソースがあること)
* Azure IoT Edge 対応の Linux VM を IoT Edge デバイスとしてデプロイする
* IoT Edge デバイスの CA 証明書を生成して構成する
* Azure portal を使用して IoT Hub で IoT Edge デバイス ID を作成する
* IoT Edge ゲートウェイのホスト名を設定する
* IoT Edge ゲートウェイ デバイスを IoT Hub に接続する
* 通信用に IoT Edge ゲートウェイ デバイス ポートを開く
* IoT Hub でダウンストリーム デバイスの ID を作成する
* ダウンストリーム デバイスを IoT Edge ゲートウェイに接続する
* イベント フローの検証

## ラボの手順

### 演習 1: ラボの前提条件を確認する

このラボでは、次の Azure リソースが使用可能であることを前提としています。

| リソースの種類 | リソース名 |
| :-- | :-- |
| リソース グループ | rg-az220 |
| IoT Hub | iot-az220-training-{your-id} |

これらのリソースが利用できない場合は、演習 2 に進む前に、以下の指示に従って **lab12-setup.azcli** スクリプトを実行する必要があります。スクリプト ファイルは、開発環境構成 (ラボ 3) の一部としてローカルに複製した GitHub リポジトリに含まれています。

> **注**:  **lab12-setup.azcli** スクリプトは、**Bash** シェル環境で実行するために記述されています。Azure Cloud Shell でこれを実行するのが、最も簡単な方法です。

1. ブラウザーを使用して [Azure Cloud Shell](https://shell.azure.com/) を開き、このコースで使用している Azure サブスクリプションでログインします。

1. Cloud Shell のストレージの設定に関するメッセージが表示された場合は、デフォルトをそのまま使用します。

1. Cloud Shell が **Bash** を使用していることを確認します。

    「Azure Cloud Shell」 ページの左上隅にあるドロップダウンは、環境を選択するために使用されます。選択されたドロップダウンの値が **Bash** であることを確認します。

1. Cloud Shell ツール バーで、「**ファイルのアップロード/ダウンロード**」 をクリックします(右から 4番目のボタン)。

1. ドロップダウンで、「**アップロード**」 をクリックします。

1. ファイル選択ダイアログで、開発環境を構成したときにダウンロードした GitHub ラボ ファイルのフォルダーの場所に移動します。

    このコースのラボ 3 にあたる「開発環境のセットアップ」では、ZIP ファイルをダウンロードしてコンテンツをローカルに抽出することで、ラボ リソースを含む GitHub リポジトリを複製しました。抽出されたフォルダー構造には、次のフォルダー パスが含まれます。

    * すべてのファイル
      * ラボ
          * 12 - IoT Edge ゲートウェイをセットアップする
            * 設定

    lab12-setup.azcli スクリプト ファイルは、ラボ 12 の設定フォルダー内にあります。

1. **lab12-setup.azcli** ファイルを選択し、「**開く**」 をクリックします。

    ファイルのアップロードが完了すると、通知が表示されます。

1. 正しいファイルがアップロードされたことを確認するには、次のコマンドを入力します。

    ```bash
    ls
    ```

    `ls` コマンドを使用して、現在のディレクトリの内容を表示します。一覧にある lab12-setup.azcli ファイルを確認できるはずです。

1. セットアップ スクリプトを含むこのラボのディレクトリを作成し、そのディレクトリに移動するには、次の Bash コマンドを入力します。

    ```bash
    mkdir lab12
    mv lab12-setup.azcli lab12
    cd lab12
    ```

    これらのコマンドは、このラボのディレクトリを作成し、**lab12-setup.azcli** ファイルをそのディレクトリに移動させ、新しいディレクトリを現在の作業ディレクトリにするための変更を行います。

1. **lab12-setup.azcli** に実行権限があることを確認するには、次のコマンドを入力します。

    ```bash
    chmod +x lab12-setup.azcli
    ```

1. Cloud Shell ツールバーで、lab12-setup.azcli ファイルへのアクセスを有効にするには、「**エディタを開く**」 (右から 2 番目のボタン - **{ }**) をクリックします。

1. 「**ファイル**」 の一覧で、lab12 フォルダーを展開してスクリプト ファイルを開き 、**lab12**、「**lab12-setup.azcli**」 の順にクリックします。

    エディタは **lab12-setup.azcli** ファイルの内容を表示します。

1. エディターで、`{your-id}` と `{your-location}` 変数の値を更新します。

    例として以下のサンプルを参照し、このコースの開始時に作成した一意の id、つまり **cah191211** に `{your-id}` を設定し、リソース グループと一致する場所に `{your-location}` を設定する必要があります。

    ```bash
    #!/bin/bash

    # Change these values!
    YourID="{your-id}"
    Location="{your-location}"
    ```

    > **注**:  `{your-location}` 変数は、すべてのリソースをデプロイするリージョンの短い名前に設定する必要があります。次のコマンドを入力すると、使用可能な場所と短い名前 (「**名前**」 の列) の一覧を表示できます。

    ```bash
    az account list-locations -o Table

    DisplayName           Latitude    Longitude    Name
    --------------------  ----------  -----------  ------------------
    East Asia             22.267      114.188      eastasia
    Southeast Asia        1.283       103.833      southeastasia
    Central US            41.5908     -93.6208     centralus
    East US               37.3719     -79.8164     eastus
    East US 2             36.6681     -78.3889     eastus2
    ```

1. エディター画面の右上で、ファイルに加えた変更を保存してエディターを閉じるには、「...」 をクリックし、「**エディターを閉じる**」 をクリックします。

    保存を求められたら、「**保存**」 をクリックすると、エディタが閉じます。

    > **注**:  **CTRL+S**を使っていつでも保存でき、 **CTRL+Q**を押してエディターを閉じます。

1. このラボに必要なリソースを作成するには、次のコマンドを入力します。

    ```bash
    ./lab12-setup.azcli
    ```

    これは、実行するのに数分かかります。各ステップが完了すると、出力が表示されます。

スクリプトが完了したら、ラボを続行することができます。

### 演習 2: Linux VM をデプロイし、IoT Edge ランタイムをインストールする

この演習では、Ubuntu サーバー VM をデプロイします。

1. 必要な場合は、お使いの Azure アカウントの資格情報を使用して Azure portal にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントを使用してログインしていることを確認してください。

1. 「**リソース、サービス、ドキュメントの検索**」 フィールドに、「**仮想マシン**」と入力します。

1. 検索結果の 「**サービス**」 で 「**仮想マシン**」 をクリックします。

1. 「**仮想マシン**」 ページで、「**+ 作成**」 をクリックして 「**仮想マシン**」 を選択します。

1. 「**仮想マシンの作成**」 ブレードの 「**サブスクリプション**」 ドロップダウンで、このコースに使用するサブスクリプションが選択されていることを確認します。

1. 「**リソース グループ**」 ドロップダウンで、「**rg-az220vm**」 をクリックします。

    > **注**: このコースで作成されたすべての仮想マシン リソースに 1 つのリソース グループが使用されます。**rg-az220vm** リソース グループがまだ作成されていない場合は、次の手順を使用して今すぐ作成してください。

    * 「**リソース グループ**」 ドロップダウンで、「**新規作成**」 をクリックします。
    * コンテキスト メニューの 「**名前**」 で、「**rg-az220vm**」と入力し、「**OK**」 をクリックします。

    > **注**: VM ごとに個別のリソース グループを作成することを提案するガイダンスが表示される場合があります。実稼働環境では、VM ごとに個別のリソース グループを用意すると、VM に追加する追加リソースを管理するのに役立ちます。このコースで VM を使用する簡単な方法では、VM ごとに個別のリソース グループを用意する必要はなく、実用的でもありません。

1. 「**インスタンスの詳細**」 の下にある 「**仮想マシン名**」 テキストボックスに、「**vm-az220-training-gw0001-{your-id}**」と入力します。

1. 「**リージョン**」 ドロップダウンで、Azure IoT Hub がプロビジョニングされているリージョンを選択します。

1. **可用性オプション**を、「**インフラストラクチャ冗長は必要ありません**」 のままにします。

1. 「**イメージ**」 フィールドで、「**Ubuntu Server 18.04LTS-Gen1** イメージ」 を選択します。

1. 「**Azure Spot インスタンス**」 フィールドをオフのままにします。

1. 「**サイズ**」 の右側にある 「**サイズの変更**」 をクリックします。

1. 「**VM サイズの選択**」 ブレードの 「**VM サイズ**」 で、「**Standard_B1ms**」、「**選択**」 の順にクリックします。

    「**すべてのフィルターをクリア**」 リンクを使用して、このサイズを一覧で表示されるようにする必要があります。

    > **注**: すべてのリージョンですべての VM サイズを使用できるわけではありません。後の手順で VM サイズを選択できない場合は、別のリージョンを試してください。たとえば、**米国西部** で利用できるサイズがない場合は、**米国西部 2** を試してみてください。

1. 「**管理者アカウント**」 の 「**認証の種類**」 の右側で、「**パスワード**」 をクリックします。

1. VM 管理者アカウントの場合は、「**ユーザー名**」、「**パスワード**」、「**パスワードの確認入力**」 の各フィールドの値を入力します。

    > **重要:** これらの値を失くしたり忘れたりしないでください - それらが無いと VM に接続できません。

1. **受信ポートの規則**は、VM の受信 **SSH** アクセスを有効にするために構成されていることに注意してください。

    これは、VM をにリモートで設定して管理するために使用されます。

1. 「**確認および作成**」 をクリックします。

1. 「**検証に成功しました**」というメッセージがブレードの上部に表示されるのを待ち、「**作成**」 をクリックします。

    > **注**:  デプロイが完了するには 5 分ほどかかる場合があります。デプロイ中に次の演習に進むことができます。

### 演習 3: IoT Edge デバイスの CA 証明書を生成して構成する

この演習では、Linux を使用してテスト証明書を生成します。これを行うには、作成した **vm-az220-training-gw0001- {your-id}** 仮想マシンと、このラボの "スターター" フォルダー内にあるヘルパー スクリプトを使用します。

#### タスク 1: VM に接続する

1. IoT Edge 仮想マシンが正常にデプロイされたことを確認します。

    Azure portal で通知ウィンドウを確認できます。

1. **rg-az220vm** リソース グループが Azure ダッシュボードに固定されていることを確認します。

    リソース グループをダッシュボードに固定するには、Azure ダッシュボードに移動して、次の手順を実行します。

    * Azure portal メニューで、**「リソース グループ」** をクリックします。
    * 「**リソース グループ**」 ブレードの 「**名前**」 で、**rg-az220vm** リソース グループを見つけます。
    * **rg-az220vm** 行でブレードの右側にある 「...」 をクリックした後、**「ダッシュボードにピン留め」** をクリックします。

    ダッシュボードを編集して、RG タイルとリストに表示されたリソースへのアクセスを容易にすることもできます。

1. Azure portal メニューで、**「リソース グループ」** をクリックします。

1. 「**リソース グループ**」 ブレードの 「**名前**」 で、**rg-az220vm** を見つけます。

1. **rg-az220vm** の向かいにあるブレードの右側で 「**クリックしてコンテキスト メニューを開く**」 (省略記号アイコン - 「...」) をクリックします

1. コンテキスト メニューで、「**ダッシュボードにピン留めする**」 をクリックし、ダッシュボードに戻ります。

    リソースへのアクセスが容易にする場合は、ダッシュボードを**編集**して、タイルを並べ替えることができます。

1. **rg-az220vm** リソース グループ タイルで、Edge ゲートウェイ仮想マシンを開くために、「**vm-az220-training-gw0001-{your-id}**」 をクリックします。

    > **注**: リソース名は長く、一部は類似しているので、ディスク、パブリック IP アドレス、またはネットワーク セキュリティ グループではなく、必ず VM を選択してください。

1. 「**vm-az220-training-gw0001-{your-id}**」 ブレードの上部にある 「**接続**」 をクリックし、「**SSH**」 をクリックします。

1. 「**接続**」 ウィンドウの 「**4. 次のコマンドの例を実行して VM に接続する**」 で、サンプル コマンドをコピーします。

    これは、VM の IP アドレスと管理者ユーザー名を含む仮想マシンに接続するために、使用できるサンプル SSH コマンドです。コマンドは、`ssh username@52.170.205.79` のように形式化される必要があります。

    > **注**: サンプル コマンドが **i \<private key path\>** を含む場合は、テキスト エディターを使用してコマンドのその部分を削除し、更新されたコマンドをクリップボードにコピーします。

1. Azure portal のツールバーで、「**Cloud Shell**」 をクリックします。

1. Cloud Shell コマンド プロンプトで、テキスト エディターで更新した **ssh** コマンドを貼り付け、**Enter キー**を押します。

1. 「**接続を続行しますか?**」というメッセージが表示されたら、「**yes**」と入力して **Enter** キーを押します。

    VM への接続をセキュリティで保護するために使用される証明書が自己署名であるため、このプロンプトがセキュリティの確認となります。このプロンプトに対する回答は、後続の接続で記憶されます。また、これは最初の接続でのみ表示されます。

1. パスワードを入力するよう求められたら、Edge ゲートウェイ VM がプロビジョニングされる時に作成した管理者パスワードを入力します。

1. 接続されると、ターミナルは次のように Linux VM の名前を表示するように変更されます。これにより、接続された VM が分かります。

    ``` bash
    username@vm-az220-training-gw0001-{your-id}:~$
    ```

    > **重要**: 接続すると、Edge VM に対して未処理の OS 更新プログラムがあることを知らせてくれます。このラボのアクティビティ中は更新を省略できますが、運用環境では、常に Edge デバイスを最新の状態に保つ必要があります。

#### タスク 2: 証明書の生成

1. Azure IoT Edge ヘルパー スクリプトをダウンロードして構成するには、次のコマンドを入力します。

    ```bash
    git clone https://github.com/Azure/iotedge.git
    ```

    **Azure/IoTEdge** GitHub プロジェクトには、**非運用**証明書を生成するスクリプトが含まれます。これらのスクリプトは、Transparent IoT Edge ゲートウェイを設定するために必要なスクリプトの作成に役立ちます。

    > **注**:  [Azure/iotedge](https://github.com/Azure/iotedge) オープンソース プロジェクトは、Azure IoT Edge の公式オープンソース プロジェクトです。このプロジェクトには、このユニットで使用されるヘルパー スクリプトに加え、Edge Agent、Edge Hub、IoT Edge Security Daemon のソース コードが含まれています。

1. "lab12" という名前の作業ディレクトリを作成して、そのディレクトリに移動するには、次のコマンドを入力します。

    ```bash
    mkdir lab12
    cd lab12
    ```

    > **注**: 証明書を生成するには、ゲートウェイ VM の "lab12" ディレクトリを使用します。証明書を生成するには、その作業ディレクトリにヘルパー スクリプトをコピーする必要があります。

1.  ヘルパー スクリプトを lab12 ディレクトリにコピーするには、次のコマンドを入力します。

    ```bash
    cp ../iotedge/tools/CACertificates/*.cnf .
    cp ../iotedge/tools/CACertificates/certGen.sh .
    ```

    これらのコマンドによって、テスト CA 証明書を生成するためのヘルパー スクリプトの実行に必要なファイルだけがコピーされます。このラボでは、Azure/iotedge リポジトリ内の残りのソース ファイルは必要ありません。

1. ヘルパー スクリプト ファイルが正しくコピーされたことを確認するには、次のコマンドを入力します。

    ```bash
    ls
    ```

    このコマンドは、ディレクトリ内に 2 つのファイルがあることを示すファイル リストを出力します。**certGen.sh** はヘルパー Bash スクリプトであり、**openssl_root_ca.cnf** ファイルは、OpenSSL を使用するヘルパー スクリプトで証明書を生成するために必要な構成ファイルです。

    コマンド プロンプトに **~/lab12** が含まれていることを確認し、正しい場所でコマンドを実行していることを確認します。これは、**/home/\<username\>/lab12** ディレクトリにマップされ、**\<username\>** は SSH にログインしたユーザーです。後で、生成後の証明書を使用するように Azure IoT Edge を構成するとき、このディレクトリの場所を使用する必要があります。

1. ルート CA 証明書と 1 つの中間証明書を生成するには、次のコマンドを入力します。

    ```bash
    ./certGen.sh create_root_and_intermediate
    ```

    **certGen.sh** ヘルパー スクリプトは、**create_root_and_intermediate** パラメーターを使用して、ルート CA 証明書と 1 つの中間証明書を生成します。スクリプトは、複数の証明書とキー ファイルを作成します。このラボの後半では、次のルート CA 証明書ファイルを使用します。

    ```text
    # Root CA certificate
    ~/lab12/certs/azure-iot-test-only.root.ca.cert.pem
    ```

    ルート CA が生成されたので、IoT Edge デバイス CA 証明書と秘密キーを生成する必要があります。

1. IoT Edge デバイス CA 証明書を生成するには、次のコマンドを入力します。

    ```bash
    ./certGen.sh create_edge_device_ca_certificate "MyEdgeDeviceCA"
    ```

    生成される証明書は、このコマンドに指定された名前を使用して作成されます。**MyEdgeDeviceCA** 以外の名前を使用すると、生成された証明書にはその名前が反映されます。

    このスクリプトによっていくつかの証明書とキー ファイルが作成されました。後で参照される次のファイルをメモします。

    ```text
    # Device CA certificate
    ~/lab12/certs/iot-edge-device-ca-MyEdgeDeviceCA-full-chain.cert.pem
    # Device CA private key
    ~/lab12/private/iot-edge-device-ca-MyEdgeDeviceCA.key.pem
    ```

    > **注**: IoT Edge デバイス CA 証明書が生成されたので、ルート CA 証明書が生成される前のコマンドを再実行しないでください。そうすることによって、既存の証明書が生成されたばかりの **MyEdgeDeviceCA** IoT Edge デバイス CA 証明書と一致しなくなる、新しい証明書で上書きされます。

#### タスク 3: Microsoft インストール パッケージをパッケージ マネージャーに追加する

1. Microsoft インストール パッケージにアクセスするように VM を構成するには、次のコマンドを実行します。

    ```bash
    curl https://packages.microsoft.com/config/ubuntu/18.04/multiarch/prod.list > ./microsoft-prod.list
    ```

1. ダウンロードしたパッケージ リストをパッケージ マネージャーに追加するには、次のコマンドを実行します。

    ```bash
    sudo cp ./microsoft-prod.list /etc/apt/sources.list.d/
    ```

1. パッケージをインストールするには、Microsoft GPG 公開鍵をインストールする必要があります。次のコマンドを実行します。

    ```bash
    curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
    sudo cp ./microsoft.gpg /etc/apt/trusted.gpg.d/
    ```

    > **重要**: Azure IoT Edge ソフトウェア パッケージには、パッケージ内にあるライセンス条項 (**usr/share/doc/{package-name}** または **LICENSE** ディレクトリ) が適用されます。パッケージを使用する前に、ライセンス条項をお読みください。インストールし、パッケージを使用すると、これらの条項に同意したものと見なされます。ライセンス条項に同意しない場合は、そのパッケージを使用しないでください。

#### タスク 4: コンテナー エンジンをインストールする

Azure IoT Edge は、OCI と互換性のあるコンテナー ランタイムに依存します。実稼働の本番シナリオでは、Moby エンジンをお勧めします。Moby エンジンは、Azure IoT Edge で公式にサポートされている唯一のコンテナー エンジンです。Docker CE/EE コンテナー イメージは、Moby ランタイムと互換性があります。

1. デバイスのパッケージ リストを更新するには、次のコマンドを実行します。

    ```bash
    sudo apt-get update
    ```

    このコマンドの実行には、数分かかる場合があります。

1. **Moby** エンジンをインストールするには、次のコマンドを実行します。

    ```bash
    sudo apt-get install moby-engine
    ```

    続行するように求められたら、「**Y**」を入力します。インストールには数分かかる場合があります。

#### タスク 5: IoT Edge をインストールする

IoT Edge セキュリティ デーモンによって、IoT Edge デバイス上にセキュリティ標準が提供されて維持されます。デーモンは起動のたびに開始され、IoT Edge ランタイムの残りの部分を開始することでデバイスをブートストラップします。

1. 通常、新しいパッケージをインストールする前にパッケージ リストを更新することをお勧めしますが、パッケージは前のタスクで更新されました。デバイスのパッケージ リストを更新するには、次のコマンドを実行します。

    ```bash
    sudo apt-get update
    ```

1. 使用可能な **IoT Edge ランタイム**のバージョンを一覧表示するには、次のコマンドを実行します。

    ```bash
    apt list -a iotedge
    ```

    > **ヒント**: このコマンドは、以前のバージョンのランタイムをインストールする必要がある場合に役立ちます。

1. 最新バージョンの **IoT Edge ランタイム**をインストールするには、次のコマンドを実行します。

    ```bash
    sudo apt-get install iotedge
    ```

    続行するように求められたら、「**Y**」を入力します。インストールには数分かかる場合があります。

    > **ヒント**: `apt list -a iotedge` コマンドの出力に表示される以前のバージョン (**1.0.9-1** など) をインストールする場合は、次のコマンドを使用します。
    > ```bash
    > sudo apt-get install iotedge=1.0.9-1 libiothsm-std=1.0.9-1
    > ```

1. Azure IoT Edge ランタイムが VM にインストールされていることを確認するには、次のコマンドを実行します。

    ```bash
    iotedge version
    ```

    このコマンドは、仮想マシンに現在インストールされている Azure IoT Edge ランタイムのバージョンを出力します。

#### タスク 6: IoT Edge を構成する

1. Azure IoT Edge を構成できることを確認するには、次のコマンドを入力します。

    ```bash
    sudo chmod a+w /etc/iotedge/config.yaml
    ```

    Azure IoT Edge を構成するには、IoT Edge デバイス上の証明書とキー ファイルへの完全なパスを含む、**/etc/iotedge/config.yaml** 構成ファイルを変更する必要があります。ファイルを編集できるようにする前に、**config.yaml** ファイルが読み取り専用でないことを確認する必要があります。上記のコマンドは、**config.yaml** ファイルを書き込み可能に設定します。

1. vi/vim エディター内で **config.yaml** ファイルを開くには、次のコマンドを入力します。

    ```bash
    sudo vi /etc/iotedge/config.yaml
    ```

    > **注**: むしろ **code**、**nano**、**emacs** などの別のエディターを使いたい場合は、それでも構いません。

1. vi/vim エディターで、「**証明書設定**」 セクションが見つかるまでファイル内を下にスクロールします。

    > **注**:  **config.yaml** ファイルを編集する際に **vi** を使用するためのヒントがあります。
    > * **i** キーを押すとエディターは挿入モードになり、変更を行うことができます。
    > * **Esc** キーを押して挿入モードを停止し、標準モードに戻ります。
    > * 保存して終了するには、「**x**」と入力して **Enter** キーを押します。
    > * ファイルを保存するには、「**W**」と入力して **Enter** キーを押します。
    > * 終了するには、「**quit**」と入力して **Enter** キーを押します。
    >
    > 保存または終了する前に、挿入モードを停止する必要があります。

1. **証明書**コードの行を更新するには、先頭の '# ' (ポンド記号とスペース) 文字を削除し、以下に示すように証明書のパスを入力します。

    ```yaml
    certificates:
      device_ca_cert: "/home/<username>/lab12/certs/iot-edge-device-ca-MyEdgeDeviceCA-full-chain.cert.pem"
      device_ca_pk: "/home/<username>/lab12/private/iot-edge-device-ca-MyEdgeDeviceCA.key.pem"
      trusted_ca_certs: "/home/<username>/lab12/certs/azure-iot-test-only.root.ca.cert.pem"
    ```

    > **注**: 上記のファイル パスの指定内の `<username>` プレースホルダーを必ず置き換えてください。SSH に接続しているユーザー (VM の作成時に指定した管理者ユーザー) の**ユーザー名**を指定する必要があります。

    > **重要**: YAML は、スペースを重要な文字として扱います。上で入力した行で、これは **certificates:** の前に先頭のスペースがあってはならないこと、および **device_ca_cert:**、**device_ca_pk:**、および **trusted_ca_certs:** の前に 2 つの先頭スペースがあることを意味します。

    このセクションで構成した X.509 証明書は次の目的で使用されます。

    | 設定 | 目的 |
    | :--- | :--- |
    | **device_ca_cert** | これは IoT Edge デバイスのデバイス CA 証明書です。 |
    | **device_ca_pk** | これは IoT Edge デバイスのデバイス CA 秘密キーです。 |
    | **trusted_ca_certs** | これはルート CA 証明書です。この証明書には、Edge モジュール通信に必要な信頼されている CA 証明書をすべて含める必要があります。|

1. 変更を保存してエディターを終了するには、「**x**」と入力して **Enterキー**を押します。

    vi/vim エディターを保存または終了する前に、「挿入」モードを停止する必要があることを忘れないでください。

1. SSH セッションを終了するには、Cloud Shell コマンド プロンプトで次のコマンドを入力します。

    ```sh
    exit
    ```

    次に、**vm-az220-training-gw0001-{your-id}** 仮想マシンから **MyEdgeDeviceCA** 証明書を "ダウンロード" して、Azure IoT Hub Device Provisioning Service 内で IoT Edge デバイス登録の構成に使用できるようにします。

1. Cloud Shell コマンド プロンプトで、**vm-az220-training-gw0001-{your-id}** 仮想マシンから **Cloud Shell** ストレージに **~/lab12** ディレクトリをダウンロードするには、次のコマンドを入力します。

    ```bash
    mkdir lab12
    scp -r -p <username>@<ipaddress>:~/lab12 .
    ```

    > **注**: **<username>** プレースホルダーを VM の管理者ユーザーのユーザー名に置き換え、**<ipaddress>** プレースホルダーを VM の IP アドレスに置き換えます。必要に応じて、SSH セッションを開くために使用されるコマンドを参照してください。

1. プロンプトが表示されたら、VM の管理者パスワードを入力します。

    コマンドが実行されると、SSH 経由で証明書とキー ファイルを含む **~/lab12** ディレクトリのコピーが Cloud Shell ストレージにダウンロードされます。

1. ファイルがダウンロードされたことを確認するには、次のコマンドを入力します。

    ```bash
    cd lab12
    ls
    ```

    次の一覧表示されたファイルを確認する必要があります。

    ```bash
    certGen.sh  csr        index.txt.attr      index.txt.old  openssl_root_ca.cnf  serial
    certs       index.txt  index.txt.attr.old  newcerts       private              serial.old
    ```

    ファイルが **vm-az220-training-gw0001-{your-id}** 仮想マシンから Cloud Shell ストレージにコピーされたら、必要に応じて、任意の IoT Edge デバイス証明書とキー ファイルをローカル コンピューターに簡単にダウンロードできるようになります。`download <filename>` コマンドを使用して、ファイルを Cloud Shell からダウンロードできます。ラボの後半でこれを行います。

### 演習 4: Azure portal を使用して IoT Hub に IoT Edge デバイス ID を作成する

この演習では、Azure IoT Hub を使用して、IoT Edge 透過ゲートウェイ (IoT Edge VM) に使用する新しい IoT Edge デバイス ID を作成します。

1. 必要な場合は、お使いの Azure アカウントの資格情報を使用して Azure portal にログインし、Azure ダッシュボードに移動します。

1. **rg-az220** リソース グループ タイルで、IoT Hub を開くには、**「iot-az220-training-{your-id}」** をクリックします。

1. 「**iot-az220-training-{your-id}**」 ブレードの 「**「自動デバイス管理**」 の左側のナビゲーション メニューで、「**IoT Edge**」 をクリックします。

    「IoT Edge」 ペインを使用すると、IoT Hub に接続されている IoT Edge デバイスを管理できます。

1. ペインの上部で、「**IoT Edge デバイスの追加**」 をクリックします。

1. 「**デバイスの作成**」 ブレードの 「**デバイス ID**」 フィールドで、「**vm-az220-training-gw0001-{your-id}**」と入力します。

    {your-id} をコースの開始時に作成した値に必ず置き換えてください。これは、認証とアクセス制御に使用されるデバイス ID です。

1. 「**認証タイプ**」 で 「**「対称キー**」 が選択されていることを確認し、「**キーの自動生成**」 ボックスをオンのままにします。

    これにより、IoT Hub はデバイスを認証するための対称キーを自動的に生成します。

1. その他の設定は既定のままにして、「**保存**」 をクリックします。

    しばらくすると、新しい IoT Edge デバイスが IoT Edge デバイスの一覧に追加されます。

1. 「**デバイス ID**」 で 「**vm-az220-training-gw0001-{your-id}**」 をクリックします。

1. 「**vm-az220-training-gw0001-{your-id}**」 ブレードで **プライマリ接続文字列**をコピーします。

    値の右側に 「コピー」 ボタンが表示されます。

1. **プライマリ接続文字列**の値をファイルに保存し、関連付けられているデバイスに関するメモを取ります。

1. **「vm-az220-training-gw0001-{your-id}」** ブレードで、**モジュール**の一覧が **\$edgeAgent** と **\$edgeHub** に制限されていることに注意してください。

    IoT Edge エージェント (**\$edgeAgent**) および IoT Edge Hub (**\$edgeHub**) モジュールは、IoT Edge ランタイムの一部です。Edge ハブは通信を担当し、Edge エージェントはデバイスにモジュールを展開して監視します。

1. ブレードの上部で、「**モジュールの設定**」 をクリックします。

    「**デバイスにモジュールを設定する**」 ブレードを使用して、IoT Edge デバイスにモジュールを追加できます。しかし、さしあたりは、このブレードを使用して IoT Edge ゲートウェイ デバイスに対し、メッセージ ルーティングが正しく構成されていることを確認します。

1. 「**デバイスにモジュールを設定する**」 ブレードの上部で、「**ルート**」 をクリックします。

    「**ルート**」 の下に、IoT Edge デバイス用に構成された既定のルートがエディタによって表示されます。この時点で、すべてのモジュールから Azure IoT Hub にすべてのメッセージを送信するルートを用いて構成されている必要があります。ルート構成がこれに一致しない場合は、次のルートに一致させるために更新します。

    * **名前**: `route`
    * **値**: `FROM /* INTO $upstream`

    メッセージ ルートの `FROM /*` 部分は、すべての device-to-cloud メッセージ、または任意のモジュールまたはリーフ デバイスからのツイン変更通知と一致します。次に、`INTO $upstream` は、これらのメッセージを Azure IoT Hub に送信するルートを示します。

    > **注**:  Azure IoT Edge 内のメッセージ ルーティングの構成に関する詳細については、[IoT Edge にモジュールをデプロイしてルートを確立する方法の詳細](https://docs.microsoft.com/azure/iot-edge/module-composition#declare-routes#declare-routes)]に関するドキュメント記事を参照してください。

1. ブレードの最下部で、**レビュー + 作成**をクリックします。

    「**デバイスにモジュールを設定する**」 ブレードのこのタブには、Edge デバイスの配置マニフェストが表示されます。ブレードの上部に「検証が成功しました」というメッセージが表示されるはずです。

1. 時間をとって配置マニフェストを確認してください。

1. ブレードの最下部で、**作成**をクリックします。

### 演習 5: IoT Edge ゲートウェイのホスト名を設定する

この演習では、**vm-az220-training-gw0001-{your-id}** のシミュレートされた Edge デバイスのパブリック IP アドレス用の DNS 名を構成し、その DNS 名を IoT Edge ゲートウェイ デバイスの`hostname`として構成します。

1. 必要な場合は、お使いの Azure アカウントの資格情報を使用して Azure portal にログインし、ダッシュボードに移動します。

1. **rg-az220vm** リソース グループ タイルで、IoT Edge 仮想マシンを開くために、「**vm-az220-training-gw0001-{your-id}**」 をクリックします。

1. 「**vm-az220-training-gw0001-{your-id}**」 ブレードの上部セクションで、「**DNS 名**」 フィールドを見つけます。

    「概要」 ブレードの上部にある 「要点」 セクションが折りたたまれている場合は、「**要点**」 をクリックします。

1. 「**DNS 名**」 フィールドの右側にある 「**構成**」 をクリックします。

1. 「**vm-az220-training-gw0001-{your-id}-ip - Configuration**」 ペインの 「**DNS 名ラベル**」 フィールドで、「**vm-az220-training-gw0001-{your-id}**」と入力します。

    このラベルは、グローバルに一意であり、かつ小文字、数字、ハイフンのみである必要があります。

1. ブレードの上部で、「**保存**」 をクリックします。

1. 「**DNS 名ラベル**」 フィールドの下と右側にテキストが表示されています。

    **westus2.cloudapp.azure.com** のようになりますが、おそらく別のリージョンがリストされます。

    完全な DNS 名は、**DNS 名ラベル** フィールドの下に位置するこのテキストを末尾に追加した **vm-az220-training-gw0001-{your-id}** の値で構成されます。

    たとえば、完全な DNS 名は次のようになります。

    ```text
    vm-az220-training-gw0001-cah191230.westus2.cloudapp.azure.com
    ```

    標準 Azure 商用クラウド内のすべてのパブリック IP アドレス DNS 名は、**cloudapp.azure.com**ドメイン名になります。これは、**westus2** Azure リージョンでホストされている VM の例です。DNS 名のこの部分は、VM がホストされている Azure リージョンによって異なります。

    **vm-az220-training-gw0001-{your-id}** 仮想マシンのパブリック IP アドレス用の DNS 名を設定すると、それに接続するために、**GatewayHostName** として使用するダウンストリーム デバイスの FQDN (完全修飾ドメイン名) が提供されます。この場合、VM はインターネット経由でアクセスできるため、インターネット DNS 名が必要とされます。Azure IoT Edge ゲートウェイがプライベート ネットワークまたはハイブリッド ネットワークでホストされている場合、コンピューター名は、オンプレミスのダウンストリーム デバイスが接続するために **GatewayHostName** の要件を満たします。

1. **vm-az220-training-gw0001-{your-id}** 仮想マシンの完全な DNS 名のレコードを作成し、後の参照用に保存します。

1. 「**vm-az220-training-gw0001-{your-id}**」 ブレードに戻り、「**更新**」 をクリックします。

    > **注**: 「IP 構成」 ブレードに残っている場合は、ページ上部の階層リンクを使用すると、VM にすばやく戻ることができます。  その場合は、「**概要**」 ペインの上部にある 「更新」 ボタンを使用して、表示内の DNS 名を更新します。

1. ブレードの上部にある 「**接続**」 をクリックし、「**SSH**」 をクリックします。

1. 前のように、「**4. 次のコマンド例を実行して VM に接続する**」の値を見つけます。

1. このコマンド例には、以前に含まれていた IP アドレスではなく、新しい DNS 名が含まれていることに注意してください。

1. 「**4. 次のコマンド例を実行して VM に接続する**」で、コマンドをコピーするには 「**クリップボードにコピー**」 をクリックします。

    この SSH コマンド例は、VM の IP アドレスと管理者ユーザー名を含む仮想マシンに接続するために使用できます。DNS 名ラベルが構成されたので、コマンドは次のようになります。 **ssh demouser@vm-az220-training-gw0001-{your-id}.eastus.cloudapp.azure.com**

    > **注**: サンプル コマンドが **i \<private key path\>** を含む場合は、テキスト エディターを使用してコマンドのその部分を削除し、更新されたコマンドをクリップボードにコピーします。

1. Azure portal のツール バーで、**「Cloud Shell」** をクリックします。

    Cloud Shell 環境が **Bash** を使用するように設定されていることを確認します。

1. Cloud Shell コマンド プロンプトで、上で作成した `ssh` コマンドを入力し、**Enter** キーを押します。

    続行するかどうかを確認する警告が表示された場合は、「**はい**」と入力します。

1. パスワードの入力を求められたら、VM のプロビジョニング時に指定した管理者パスワードを入力します。

1. vi/vim エディター内で config.yaml ファイルを開くには、次のコマンドを入力します。

    ```bash
    sudo vi /etc/iotedge/config.yaml
    ```

    > **注**: この場合もやはり、必要に応じて別のエディターを使用できます。

1. ファイル内で下方向にスクロールして、「**Edge デバイスのホスト名**」 セクションを見つけます。

    > **注**:  **config.yaml** ファイルを編集する際に **vi** を使用するためのヒントがあります。
    > * **Esc** キーを押し、**/** に続けて検索文字列を入力し、Enter キーを押して検索します
    > * **n** キーを押すと、一致項目が順番に切り替わります。
    > * **i** キーを押すとエディターは挿入モードになり、変更を行うことができます。
    > * **Esc** キーを押して挿入モードを停止し、標準モードに戻ります。
    > * 保存して終了するには、「**x**」と入力して **Enter** キーを押します。
    > * ファイルを保存するには、「**w**」と入力して **Enter** キーを押します。
    > * vi を終了するには、「**quit**」と入力して **Enter** キーを押します。

1. **ホスト名** の値を、先ほど保存した**完全な DNS 名**の値に設定します。

    これは、**vm-az220-training-gw0001-{your-id}** 仮想マシンの**完全な DNS 名**です。

    > **注**: 名前を保存しなかった場合は、仮想マシンの 「**概要**」 ウィンドウで見つけられます。  そこからコピーして Cloud Shell ウィンドウに貼り付けることもできます。

    結果の値は次のようになります。

    ```yaml
    hostname: "vm-az220-training-gw0001-{your-id}.eastus.cloudapp.azure.com"
    ```

    `hostname` 設定により、Edge ハブ サーバーのホスト名を構成します。この設定で使用した文字種に関係なく、Edge ハブ サーバーの構成には小文字の値が使用されます。これは、ダウンストリーム IoT デバイスが暗号化された通信を正常に機能させるために IoT Edge ゲートウェイに接続する際に使用する必要があるホスト名でもあります。

1. **config.yaml** を vi/vim (または使用しているエディター) で開いたままにします

### 演習 6: IoT Edge ゲートウェイ デバイスを IoT Hub に接続する

この演習では、IoT Edge デバイスを Azure IoT Hub に接続します。

1. vi/vim の **config.yaml** ドキュメントに戻ります。

1. ファイルのthe **接続文字列を使用して手動プロビジョニング構成**を検索し、接続文字列セクションを使用して手動プロビジョニング構成のコメントを解除します。先頭の **'# '** (ポンド記号とスペース) 文字を削除除してコメントを解除していない場合は、`<ADD DEVICE CONNECTION STRING HERE>` を以前に IoT Edge デバイス用にコピーした接続文字列に置き換えます。

    ```yaml
    # Manual provisioning configuration using a connection string
    provisioning:
      source: "manual"
      device_connection_string: "<ADD DEVICE CONNECTION STRING HERE>"
      dynamic_reprovisioning: false
    ```

    > **重要**: YAML は、スペースを重要な文字として扱います。上で入力した行で、これは **provisioning:** の前に先頭のスペースがあってはならないこと、および **source:**、**device_connection_string:**、および **dynamic_reprovisioning:** の前に 2 つの先頭スペースがあることを意味します。

1. 変更を保存してエディターを終了するには、**Esc** キーを押して「**x**」と入力し、**Enter** キーを押します

1. 変更を適用するには、次のコマンドを使用して IoT Edge デーモンを再起動する必要があります。

    ```bash
    sudo systemctl restart iotedge
    ```

1. IoT Edge デーモンが実行されていることを確認するには、次のコマンドを入力します。

    ```bash
    sudo systemctl status iotedge
    ```

    このコマンドは多くのコンテンツ行を表示し、そのうち最初の 3 行はサービスが実行されているかどうかを示します。実行中のサービスの場合、出力は次のようになります。

    ```bash
    ● iotedge.service - Azure IoT Edge daemon
       Loaded: loaded (/lib/systemd/system/iotedge.service; enabled; vendor preset: enabled)
       Active: active (running) since Fri 2021-03-19 18:06:16 UTC; 1min 0s ago
    ```

1. IoT Edge ランタイムが接続されていることを確認するには、次のコマンドを実行します。

    ```bash
    sudo iotedge check
    ```

    これにより、いくつかのチェックが実行され、結果が表示されます。このラボでは、**構成チェック**の警告/エラーを無視してください。**接続チェック**は成功し、次のようになります。

    ```bash
    Connectivity checks
    -------------------
    √ host can connect to and perform TLS handshake with IoT Hub AMQP port - OK
    √ host can connect to and perform TLS handshake with IoT Hub HTTPS / WebSockets port - OK
    √ host can connect to and perform TLS handshake with IoT Hub MQTT port - OK
    √ container on the default network can connect to IoT Hub AMQP port - OK
    √ container on the default network can connect to IoT Hub HTTPS / WebSockets port - OK
    √ container on the default network can connect to IoT Hub MQTT port - OK
    √ container on the IoT Edge module network can connect to IoT Hub AMQP port - OK
    √ container on the IoT Edge module network can connect to IoT Hub HTTPS / WebSockets port - OK
    √ container on the IoT Edge module network can connect to IoT Hub MQTT port - OK
    ```

    接続が失敗した場合は、**config.yaml** の接続文字列値を再確認してください。

1. 数分待ちます。

1. IoT Edge デバイスで現在実行されているすべての **IoT Edge モジュール**を一覧表示するには、次のコマンドを入力します。

    ```sh
    iotedge list
    ```

    しばらくすると、このコマンドにより `edgeAgent` モジュールと `edgeHub` モジュールが実行されていることが示されます。出力は、以下のようなものになります。

    ```text
    root@vm-az220-training-gw0001-{your-id}:~# iotedge list
    NAME             STATUS           DESCRIPTION      CONFIG
    edgeHub          running          Up 15 seconds    mcr.microsoft.com/azureiotedge-hub:1.0
    edgeAgent        running          Up 18 seconds    mcr.microsoft.com/azureiotedge-agent:1.0
    ```

    エラーが報告された場合は、構成が正しく設定されていることを再確認する必要があります。トラブルシューティングの場合は、エラーがあるかどうかを確認するための **iotedge check --verbose** コマンドを実行できます。

1. Cloud Shell を閉じます。

### 演習 7: 通信用に IoT Edge ゲートウェイ デバイス ポートを開く

Azure IoT Edge ゲートウェイを機能させるには、ダウンストリーム デバイスから入ってくるトラフィックのために、IoT Edge ハブでサポートされているプロトコルうち、少なくとも 1 つを開いておく必要があります。サポートされているプロトコルは MQTT、AMQP、HTTPS です。

Azure IoT Edge でサポートされている IoT 通信プロトコルのポート マッピングは次のようになります。

| プロトコル | ポート番号 |
| --- | --- |
| MQTT | 8883 |
| AMQP | 5671 |
| HTTPS<br/>MQTT + WS (Websocket)<br/>AMQP + WS (Websocket) | 443 |

お使いのデバイスに選択した IoT 通信プロトコルには、IoT Edge ゲートウェイ デバイスをセキュリティで保護するファイアウォールのために、対応するポートを開いておく必要があります。このラボの場合は、IoT Edge ゲートウェイをセキュリティで保護するために Azure ネットワーク セキュリティ グループ (NSG) が使用されるため、NSG の受信セキュリティ規則は、これらのポートで開かれます。

運用シナリオでは、デバイスが通信するポートの最小数のみを開きます。MQTT を使用する場合、受信通信にはポート 8883 だけを開けてください。開くポートを増やすと、セキュリティ攻撃者に利用されるおそれがある攻撃ベクトルが増えます。セキュリティのベスト プラクティスは、ソリューションに必要な最小数のポートのみを開くことです。

この演習では、インターネットから Azure IoT Edge ゲートウェイへのアクセスをセキュリティで保護するネットワーク セキュリティ グループ (NSG) を構成します。ダウンストリーム IoT デバイスがゲートウェイと通信できるように、MQTT、AMQP、HTTPS 通信に必要なポートを開いておく必要があります。

1. 必要な場合は、お使いの Azure アカウントの資格情報を使用して Azure portal にログインします。

1. Azure ダッシュボードで、**rg-az220vm** リソース グループ タイルを見つけます。

    このリソース グループ タイルには、関連付けられたネットワーク セキュリティ グループへのリンクが含まれていることに注意してください。

1. **rg-az220vm** リソース グループのタイルで、**vm-az220-training-gw0001-{your-id}-nsg** をクリックします。

1. **「ネットワーク セキュリティ グループ」** ブレードの左側のメニューの **「設定」** で、**「アウトバウンドセキュリティ規則」** をクリックします。

1. 「**受信セキュリティ規則**」 ウィンドウの上部にある 「**追加**」 をクリックします。

1. 「**受信セキュリティ規則の追加**」 ウィンドウの 「**「宛先ポート範囲**」 で、値を **8883** に変更します。

1. 「**プロトコル**」 で 「**TCP**」 をクリックします。

1. 「**名前**」 で値を **MQTT** に変更します。

1. その他すべての設定を既定のままにして、「**追加**」 をクリックします。

    これにより、IOT Edge ゲートウェイへの MQTT プロトコルの通信を許可する受信セキュリティ規則が定義されます。

1. MQTT ルールを追加した後、**AMQP** および **HTTPS** 通信プロトコルのポートを開くには、次の値を持つ 2 つのルールを追加します。

    | 宛先ポート範囲 | プロトコル | 名前 |
    | :--- | :--- | :--- |
    | 5671 | TCP | AMQP |
    | 443 | TCP | HTTPS |

   > **注**: 新しいルールが表示されるのを確認するには、ウィンドウの上部にあるツールバーの 「**更新**」 ボタンを使用する必要がある場合があります。

1. これら 3 つのポートがネットワーク セキュリティ グループ (NSG) で開いていると、ダウンストリーム デバイスは、MQTT、AMQP、または HTTPS プロトコルを使用し、IoT Edge ゲートウェイに接続できます。

### 演習 8: IoT Hub でダウンストリーム デバイス ID を作成する

この演習では、ダウンストリーム IoT デバイスの Azure IoT Hub に新しい IoT デバイス ID を作成します。このデバイス ID は、Azure IoT Edge ゲートウェイがこのダウンストリーム デバイスの親デバイスになるように構成されます。

1. 必要な場合は、お使いの Azure アカウントの資格情報を使用して Azure portal にログインします。

1. Azure ダッシュボードで、IoT Hub を開くには、**「iot-az220-training-{your-id}」** をクリックします。

1. 「**iot-az220-training-{your-id}**」 ブレードの 「**エクスプローラー**」 の下の左側のメニューで、「**IoT デバイス**」 をクリックします。

    「IoT Hub」 ブレードのこのウィンドウを使用して、IoT Hub に接続されている IoT デバイスを管理できます。

1. ウィンドウの上部で、新しい IoT デバイスの構成を開始するには、「**+ 新規**」 をクリックします。

1. 「**デバイスの作成**」 ブレードの 「**デバイス ID**」 で、「**sensor-th-0072**」と入力します。

    これは、認証とアクセス制御に使用されるデバイス ID です。

1. 「**認証の種類**」 で、「**対称キー**」 が選択されていることを確認します。

1. 「**キーの自動生成**」 の下のボックスはオンのままにします。

    これにより、IoT Hub はデバイスを認証するための対称キーを自動的に生成します。

1. 「**親デバイス**」 で 「**親デバイスの設定**」 をクリックします。

    このラボで先ほど作成した IoT Edge ゲートウェイ デバイスを介して IoT Hub と通信するように、このダウンストリーム デバイスを構成します。

1. 「**エッジ デバイスを親デバイスとして設定する**」 ブレードの 「**デバイス ID**」 で、「**vm-az220-training-gw0001-{your-id}**」 をクリックし、「**OK**」 をクリックします。

1. 「**デバイスの作成**」 ブレードで、ダウンストリーム デバイスの IoT デバイス ID を作成するには、「**保存**」 をクリックします。

1. 「**IoT デバイス**」 ウィンドウの上部にある 「**更新**」 をクリックします。

1. **「デバイス ID」** で、**「sensor-th-0072」** をクリックします。

    これにより、このデバイスの詳細ビューが開きます。

1. 「IoT デバイスの概要」 ペインで、「**プライマリ接続文字列**」 フィールドの右側にある 「**コピー**」 をクリックします。

1. 後の参照用に接続文字列を保存します。

    この接続文字列は sensor-th-0072 の子デバイス用であることに注意してください。

### 演習 9: ダウンストリーム デバイスを IoT Edge ゲートウェイに接続する

この演習では、事前に構築されたダウンストリーム デバイスと Edge ゲートウェイ デバイス間の接続を構成します。

1. 必要な場合は、お使いの Azure アカウントの資格情報を使用して Azure portal にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントを使用してログインしていることを確認してください。

1. Azure portal のツール バーで、**「Cloud Shell」** をクリックします。

    環境が **Bash** に設定されていることを確認します。

    > **注**: Cloud Shell がすでに開いていて、Edge デバイスに接続されている場合は、**exit** コマンドを使用して SSH セッションを終了します。

1. Cloud Shell コマンド プロンプトで、IoT Edge ゲートウェイ仮想マシンのルート CA X.509 証明書をダウンロードするには、次のコマンドを入力します。

    ```bash
    download lab12/certs/azure-iot-test-only.root.ca.cert.pem
    ```

    Azure IoT Edge ゲートウェイは、以前 、ゲートウェイに接続しているダウンストリーム デバイスを使用して通信を暗号化する際に、このルート CA X.509 証明書を使用する **etc/iotedge/config.yaml** ファイル内で構成されていました。この X.509 証明書は、ゲートウェイとの通信を暗号化するために使用できるよう、ダウンストリーム デバイスにコピーされる必要があります。

1. **azure-iot-test-only.root.ca.cert.pem** X.509 証明書ファイルを、ダウンストリーム IoT デバイスのソース コードがある **Starter/DownstreamDevice** ディレクトリにコピーします。

    > **重要**: ファイルに正確な名前が付いていることを確認してください。以前のラボと異なる名前 (たとえば、**(1)** が追加されている) を持つことがあるため、必要に応じてコピー後に名前を変更します。

1. Visual Studio Code を開きます。

1. 「**ファイル**」 メニューで、「**フォルダーを開く**」 をクリックします。

1. 「**フォルダーを開く**」 ダイアログで、ラボ 12 の**スターター** フォルダーに移動し、**DownstreamDevice** をクリックして、「**フォルダーの選択**」 をクリック します。

    Program.cs ファイルと一緒に 「エクスプローラー」 ペインに一覧表示されている azure-iot-test-only.root.ca.cert.pem ファイルが表示されます。

    > **注**: dotnet を復元および/または C# 拡張機能を読み込むためのメッセージが表示された場合は、インストールを完了します。

1. エクスプローラー ウィンドウで、**Program.cs** をクリックします。

    ざっと確認すると、このアプリは以前のラボで作業した **CaveDevice** アプリケーションのバリアントであることがわかります。

1. **connectionString** 変数の宣言を見つけて、プレースホルダー値を **sensor-th-0072** IoT デバイスのプライマリ接続文字列に置き換えます。

1. 割り当てられた **connectionString** 値を **GatewayHostName** プロパティに追加し、GatewayHostName の値をIoT Edge ゲートウェイ デバイスの完全な DNS 名に設定します。

    Edge ゲートウェイ デバイスの完全な DNS 名は、デバイス ID **vm-az220-training-gw0001-{your-id}** であり、指定したリージョンと Azure 商用クラウドドメイン名が追加されます (例: **westus2.cloudapp.azure.com**)。

    完成した接続文字列値は、次の形式に一致する必要があります。

    ```text
    HostName=<IoT-Hub-Name>.azure-devices.net;DeviceId=sensor-th-0072;SharedAccessKey=<Primary-Key-for-IoT-Device>;GatewayHostName=<DNS-Name-for-IoT-Edge-Device>
    ```

    上記のプレースホルダーを適切な値に置き換えてください。

    * **\<IoT-Hub-Name\>**: Azure IoT Hub の名前。
    * **\<Primary-Key-for-IoT-Device\>**: Azure IoT Hub の **sensor-th-0072** IoT デバイスのプライマリ キー。
    * **\<DNS-Name-for-IoT-Edge-Device\>**: **vm-az220-training-gw0001-{your-id}** Edge デバイスの DNS 名。

    アセンブルされた接続文字列値を持つ **connectionString** 変数は、次のようになります。

    ```csharp
    private readonly static string connectionString = "HostName=iot-az220-training-abc201119.azure-devices.net;DeviceId=sensor-th-0072;SharedAccessKey=ygNT/WqWs2d8AbVD9NAlxcoSS2rr628fI7YLPzmBdgE=;GatewayHostName=vm-az220-training-gw0001-{your-id}.westus2.cloudapp.azure.com";
    ```

1. 「**ファイル**」 メニューの 「**上書き保存**」 をクリックします。

1. 下にスクロールして **Main** メソッドを表示し、少し時間をかけてコードをレビューします。

    このメソッドには、構成された接続文字列を使用して **DeviceClient** をインスタンス化するコードが含まれ、Azure IoT Edge ゲートウェイとの通信に使用するトランスポート プロトコルとして `MQTT` が指定されています。

    ```csharp
    deviceClient = DeviceClient.CreateFromConnectionString(connectionString, TransportType.Mqtt);
    SendDeviceToCloudMessagesAsync();
    ```

    Main メソッドは:

    * ルート CAX.509 証明書をローカル マシンに自動的にインストールするコードを含む **InstallCACert** メソッドを呼び出します。
    * シミュレートされたデバイスからイベント テレメトリを送信する **SendDeviceToCloudMessagesAsync** メソッドを実行します。

1. **SendDeviceToCloudMessagesAsync** メソッドを見つけ、少し時間をかけてコードをレビューします。

    このメソッドには、シミュレートされたデバイス テレメトリを生成し、イベントを IoT Edge ゲートウェイに送信するコードが含まれています。

1. **InstallCACert** を見つけ、ルート CA X.509 証明書をローカル マシン証明書ストアにインストールするコードを参照します。

    > **注**: この証明書は、デバイスから Edge ゲートウェイへの通信を保護するために使用されることに注意してください。デバイスは、IoT Hub での認証に接続文字列内の対称キーを使用します。

    このメソッド内の初期コードは、**azure-iot-test-only.root.ca.cert.pem** ファイルが使用可能であることを確認する役割を果たします。もちろん、実稼働アプリケーションでは、環境変数などの X.509 証明書へのパスを指定するための代替メカニズムの使用、または TPM の使用を検討する場合があります。

    X.509 証明書の存在が確認されると、**X509Store** クラスを使用して、現在のユーザーの証明書ストアに証明書がロードされます。証明書は、ゲートウェイへの通信を保護するためにオンデマンドで利用できるようになります。これはデバイス クライアント内で自動的に行われるため、追加のコードはありません。

    > **情報**: **X509Store** クラスの詳細については、[こちら](https://docs.microsoft.com/ja-jp/dotnet/api/system.security.cryptography.x509certificates.x509store?view=netcore-3.1)をご覧ください。

1. 「**ターミナル**」 メニューで、「**新しいターミナル**」 をクリックします。

1. ターミナル コマンド プロンプトで、次のコマンドを入力します。

    ```bash
    dotnet run
    ```

    このコマンドは、**sensor-th-0072** のシミュレートされたデバイスのコードをビルドして実行し、デバイス テレメトリの送信を開始します。

    > **注**: アプリが (IoT Edge ゲートウェイで認証するために使用できるように) ローカル コンピューターに X.509 証明書をインストールしようとすると、証明書のインストールに関するセキュリティ警告が表示されることがあります。アプリを続行するには、「**はい**」 をクリックする必要があります。

1. 証明書をインストールするかどうか尋ねられたら、「**はい**」 をクリックします。

1. シミュレートされたデバイスが実行されると、コンソールの出力に、Azure IoT Edge ゲートウェイに送信されているイベントが表示されます。

    ターミナル出力は次のようになります。

    ```text
    IoT Hub C# Simulated Cave Device. Ctrl-C to exit.

    User configured CA certificate path: azure-iot-test-only.root.ca.cert.pem
    Attempting to install CA certificate: azure-iot-test-only.root.ca.cert.pem
    Successfully added certificate: azure-iot-test-only.root.ca.cert.pem

    10/25/2019 6:10:12 PM > Sending message: {"temperature":27.714212817472504,"humidity":63.88147743599558}
    10/25/2019 6:10:13 PM > Sending message: {"temperature":20.017463779085066,"humidity":64.53511070671263}
    10/25/2019 6:10:14 PM > Sending message: {"temperature":20.723927165718717,"humidity":74.07808918230147}
    10/25/2019 6:10:15 PM > Sending message: {"temperature":20.48506045736608,"humidity":71.47250854944461}
    ```

    > **注**: デバイス送信が最初の送信で 1 秒以上長く一時停止しているように見える場合は、NSG 受信ルールを以前に正しく追加していなかったため、MQTT トラフィックがブロックされている可能性があります。  NSG 構成を確認します。

1. 次の演習に進むときは、シミュレートされたデバイスを実行したままにします。

### 演習 10: イベント フローの検証

この演習では、Azure CLI を使用して、IoT Edge ゲートウェイを経由してダウンストリーム IoT デバイスから Azure IoT Hub に送信されるイベントを監視します。これは、すべてが正しく動作していることを検証します。

1. 必要な場合は、お使いの Azure アカウントの資格情報を使用して Azure portal にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントを使用してログインしていることを確認してください。

1. Cloud Shell が実行されていない場合は、Azure portal のツールバーで 「**Cloud Shell**」 をクリックします。

1. Cloud Shell で SSH 接続を使用して Edge デバイスに接続している場合は、その接続を終了します。

1. Cloud Shell コマンド プロンプトで、Azure IoT Hub にフローするイベントのストリームを監視するには、次のコマンドを実行します。

    ```bash
    az iot hub monitor-events -n iot-az220-training-{your-id}
    ```

    `-n` パラメーターの `{your-id}` プレースホルダーを Azure IoT Hub の名前に置き換えてください。

    `az iot hub monitor-events` コマンドを使用すると、デバイス テレメトリと Azure IoT Hub に送信されるメッセージを監視できます。これにより、シミュレートされたデバイスから IoT Edge ゲートウェイに送信されるイベントが Azure IoT Hub によって受信されていることを確認します。

1. すべてが正常に動作すると、`az iot hub monitor-events` コマンドの出力は次のようになります。

    ```text
    chris@Azure:~$ az iot hub monitor-events -n iot-az220-training-1119
    Starting event monitor, use ctrl-c to stop...
    {
        "event": {
            "origin": "sensor-th-0072",
            "payload": "{\"temperature\":30.931512529929872,\"humidity\":78.70672198883571}"
        }
    }
    {
        "event": {
            "origin": "sensor-th-0072",
            "payload": "{\"temperature\":30.699204018199445,\"humidity\":78.04910910224966}"
        }
    }
    ```

このラボを完了してイベント フローを確認したら、**CTRL+C** キーを押してコンソール アプリケーションを終了します。
