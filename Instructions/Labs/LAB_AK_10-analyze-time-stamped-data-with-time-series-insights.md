---
lab:
    title: 'ラボ 10: Time Series Insights を使用してタイムスタンプ付きデータを探索および分析する'
    module: 'モジュール 5: インサイトとビジネス インテグレーション'
---

# Time Series Insights を使用したタイムスタンプ付きデータの探索と分析

## ラボシナリオ

Azure IoT サービスとツールを実装する努力が実を結びました。Contoso は、出荷時にチーズ容器の環境条件を監視する「資産条件トラッキング システム」を展開しました。

新しいシステムを発売してから 2 週間後、特定の出荷に対する輸送中の温度スパイクが明らかになりました。出荷中のチーズの一部は台無しになりましたが、新しいシステムは影響を受けたチーズが顧客に届けられなかったことを確認しました。監視システムの Azure IoT 側を誰よりもよく知っているので、調査を主導します。

経営陣は、将来的に製品の損失を防ぐところまで、システムを改善できるかどうかを判断するようお願いしています。出荷時に使用したトラックや飛行機から取得した IoT デバイスのセンサー データを関連付けます。トラックの 1 台の温度が車両の特定の箇所で予期せず上昇し、輸送コンテナーの 1 つ (温度と湿度を監視する IoT デバイスを搭載) に熱スパイクを発生させたようです。

チームは、監視システムをさらに改善するには、ほぼリアルタイムのデータ探索と根本原因分析が必要であると判断しました。

Azure IoT ソリューションに Time Series Insights を追加することを提案します。これにより、Contoso は、トラック、飛行機、コンテナー内の IoT デバイスによって生成される大量の時系列データを迅速に格納、視覚化、クエリを実行し、時間の経過に伴う変化を視覚化できます。 

次のリソースが作成されます。

![ラボ 10 アーキテクチャ](media/LAB_AK_10-architecture.png)

## このラボで

このラボでは、次のタスクを正常に達成します。

* ラボの前提条件が満たされていることを確認する (必要な Azure リソースがあること)
* Azure Time Series Insights (TSI) 環境の作成
* IoT ハブとシミュレートされたデバイスの作成 (CLI を使用)
* Time Series Insights (TSI) を使用して IoT ハブに接続する
* Time Series Insights でテンプレートを使用して TSI リソースを作成およびデプロイする

## ラボの手順

### 演習 1: ラボの前提条件を確認する

このラボでは、次の Azure リソースが利用可能であることを前提としています。

| リソースの種類:  | リソース名 |
| :-- | :-- |
| リソース グループ | `rg-az220` |
| IoT Hub | `iot-az220-training-{your-id}` |
| デバイス ID | `sensor-th-truck0001` |
| デバイス ID | `sensor-th-airplane0001` |
| デバイス ID | `sensor-th-container0001` |

これらのリソースが利用できない場合は、演習 2 に進む前に、以下の手順に従って **lab10-setup.azcli** スクリプトを実行する必要があります。スクリプト ファイルは、開発環境構成 (ラボ 3) の一部としてローカルに複製した GitHub リポジトリに含まれています。

**lab10-setup.azcli** スクリプトは **Bash** シェル環境で実行するように記述されています - これを実行する最も簡単な方法は、Azure Cloud Shell です。

1. ブラウザーを使用して [Azure Cloud Shell](https://shell.azure.com/) を開き、このコースで使用している Azure サブスクリプションでログインします。

1. Azure Cloud Shell が **Bash**を使用していることを確認 します。

    「Azure Cloud Shell」 ページの左上隅にあるドロップダウンは、環境を選択するために使用されます。選択されたドロップダウンの値が **Bash**であることを確認します。 

1. Azure Shell ツール バーで、「**ファイルのアップロード/ダウンロード**」 をクリックします(右から 4番目のボタン)。

1. ドロップダウンで、「**アップロード**」 をクリックします。

1. ファイル選択ダイアログで、開発環境を構成したときにダウンロードした GitHub ラボ ファイルのフォルダーの場所に移動します。

    _ラボ 3: 開発環境のセットアップ_:ZIP ファイルをダウンロードしてコンテンツをローカルに抽出することで、ラボ リソースを含む GitHub リポジトリを複製しました。抽出されたフォルダー構造には、次のフォルダー パスが含まれます。

    * Allfiles
      * Labs
          * 10-Explore and analyze time stamped data with Time Series Insights
            * Setup

    lab10-setup.azcli スクリプト ファイルは、ラボ 10 のセットアップ フォルダにあります。

1. **lab10-setup.azcli** ファイルを選択し、**Open**をクリックします。

    ファイルのアップロードが完了すると、通知が表示されます。

1. 正しいファイルが Azure Cloud Shell にアップロードされたことを確認するには、次のコマンドを入力します。

    ```bash
    ls
    ```

    `ls` コマンドを使用して、現在のディレクトリの内容を表示します。lab10-setup.azcli ファイルが一覧表示されます。

1. セットアップ スクリプトを含むこのラボのディレクトリを作成し、そのディレクトリに移動するには、次の Bash コマンドを入力します。

    ```bash
    mkdir lab10
    mv lab10-setup.azcli lab10
    cd lab10
    ```

1. **lab10-setup.azcli** に対する実行権限を確認するには、次のコマンドを入力します。

    ```bash
    chmod +x lab10-setup.azcli
    ```

1. Cloud Shell ツールバーで、lab10-setup.azcli ファイルを編集するには、「**エディターを開く**」 (右から 2 番目のボタン - **{ }**) をクリックします。

1. **Files** 一覧で、lab 10 フォルダーを展開してスクリプト ファイルを開き 「**lab10**」 をクリックしてから 「**lab10-setup.azcli**」 をクリックします。     

    エディターは **lab10-setup.azcli** ファイルの内容を表示します。 

1. エディターで、割り当て済みの値 `{YOUR-ID}` と `{YOUR-LOCATION}` を更新します。

    以下のサンプルを例として参照し `{YOUR-ID}` をこのコースの開始時に作成した一意のIDに設定する必要があります - つまり **CAH191211**、および `{YOUR-LOCATION}` をリソースにとって意味のある場所に設定する必要があります。

    ```bash
    #!/bin/bash

    YourID="{YOUR-ID}"
    RGName="rg-az220"
    IoTHubName="AZ-220-HUB-$YourID"

    Location="{YOUR-LOCATION}"
    ```

    > **注意**:  `Location` 変数は、保存先の短い名前に設定する必要があります。次のコマンドを入力すると、使用できる場所と短い名前 (「**名前**」 の列) の一覧を表示できます。
    >
    > ```bash
    > az account list-locations -o Table
    > ```
    >
    > ```text
    > DisplayName           Latitude    Longitude    Name
    > --------------------  ----------  -----------  ------------------
    > East Asia             22.267      114.188      eastasia
    > Southeast Asia        1.283       103.833      southeastasia
    > Central US            41.5908     -93.6208     centralus
    > East US               37.3719     -79.8164     eastus
    > East US 2             36.6681     -78.3889     eastus2
    > ```

1. エディター画面の右上で、ファイルに加えた変更を保存してエディタを閉じるには、「..」 をクリックし、「**エディタを閉じる**」 をクリックします。 

    保存を求められたら、「**保存**」 をクリックすると、エディタが閉じます。 

    > **注意**:  **CTRL+S**を使っていつでも保存でき、 **CTRL+Q**を押してエディターを閉じます。

1. このラボに必要なリソースを作成するには、次のコマンドを入力します。

    ```bash
    ./lab10-setup.azcli
    ```

    このスクリプトの実行には数分かかります。各ステップが完了すると、JSON 出力が表示されます。

    このスクリプトは、まず **rg-az220** という名前のリソース グループ と **iot-az220-training-{your-id}** という名前の IoT ハブを作成します。  既に存在する場合は、対応するメッセージが表示されます。次に、スクリプトは IoT ハブに 3 つのデバイスを追加し、デバイスの接続文字列を表示します。デバイス ID は次のとおりです。**sensor-th-truck0001**、**sensor-th-airplane0001**、および **sensor-th-container0001**。   

1. スクリプトが完了すると、各デバイスの接続文字列が表示されます。

    接続文字列は「HostName=」で始まります。

1. 各デバイスの接続文字列をテキスト ドキュメントにコピーします。

    接続文字列を簡単に見つけることができる場所に保存したら、課題を続ける準備が整います。接続文字列は、関連付けられているデバイスのデバイス ID を指定します。

### 演習 2: Time Series Insights の設定

Azure Time Series Insights (TSI) は、IoT ソリューションのデータを大規模に収集、処理、保存、分析、クエリするために使用されるエンドツーエンドのサービスとしてのプラットフォーム オファリングです。TSI は、時系列に対して高度にコンテキスト化および最適化されたデータのアドホック データ探索と運用分析のために設計されています。

この演習では、Azure IoT Hub と Time Series Insights の統合を設定します。

1. Azure アカウントの資格情報を使用して [portal.azure.com](https://portal.azure.com) にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントでログインしていることを確認してください。

1. Azure portal の左側のナビゲーション メニューで、「**リソースの作成**」 をクリックします。

1. 「**新規**」 ブレードの 「**Marketplace を検索**」 テキストボックスに、「**Time Series Insights**」と入力します。

1. 検索結果で、「**Time Series Insights**」 をクリックします。

1. 「**Time Series Insights**」 ブレードで、「**作成**」 をクリックします。

1. 「**Time Series Insights 環境の作成**」 ブレードの 「**環境名**」 フィールドに 、「**tsi-az220-training**」と入力します。

1. 「**サブスクリプション**」 ドロップダウンで、このコースに使用するサブスクリプションを選択します。

1. 「**リソース グループ**」 ドロップダウンで、「**rg-az220-RG**」 をクリックします。

1. 「**場所**」 のドロップダウンで、最も近い Azure リージョンを選択します。

1. 「**層**」 フィールドで、「**Gen2(L1)**」 が選択されていることを確認します。

1. 「プロパティ名」に`iothub-connection-device-id`と入力します。

1. 「コールドストア」フィールドで、新しく作成するストレージアカウントの名前を入力します。

1. ブレードの最下部で、「**次へ:**」 をクリックします。**イベント ソース**。

1. 「**イベント ソースの詳細**」 セクションで、「**イベント ソースを作成しますか?**」 は 「**はい**」 に設定します。

1. 「**ソースの種類**」 ドロップダウンで、「**IoT ハブ**」 が選択されていることを確認します。

1. 「**名前**」 フィールドに「**iot-az220-training-{your-id}**」と入力して、このイベント ソースの一意の名前を指定します。

1. 「**サブスクリプション**」 ドロップダウンで、このコースに使用するサブスクリプションを選択します。

1. 「**IoT ハブ名**」 ドロップダウンで、既にプロビジョニングされている **iot-az220-training-{your-id}** Azure IoT Hub サービスを選択します。   

1. 「**IoT ハブ アクセス ポリシー名**」 ドロップダウンで 「**iothubowner**」 をクリックします。   

    運用環境では、Azure IoT Hub 内に新しい_アクセス ポリシー_を作成し、Time Series Insights (TSI) アクセスの構成に使用することをお勧めします。  これにより、TSI のセキュリティは、同じ Azure IoT Hub に接続されている他のサービスとは独立して管理できるようになります。  ここでは便宜上の理由から、これを行っていません。

1. 「**コンシューマー グループ**」セクションで、「**IoT Hub コンシューマー グループ**」ドロップダウンの横にある「**新規**」をクリックします。     

1. 「**IoT ハブ コンシューマー グループ**」ボックスに**tsievents** と入力し、「**追加**」をクリックします。     

    これにより、このイベント ソースに使用する新しい_コンシューマー グループ_が追加されます。コンシューマー グループは、特定のコンシューマー グループから同時に 1 つのアクティブ リーダーしか存在できないので、このイベント ソースを専用に使用する必要があります。

1. **タイムスタンプ** セクションの下 の **プロパティ名**を空白のままにします。 

1. ブレードの最下部で、**レビュー + 作成**をクリックします。

    > **注意**: *イベント ソース * ウィンドウにすぐに戻ってきた場合は、**IoT ハブ コンシューマー グループ** フィールドの右側にある**追加**をクリックしたことを再確認します。 コンシューマーグループを作成するまで TSI リソースを作成できません。

1. ブレードの最下部で、**作成**をクリックします。

    > **注意**:  Time Series Insights (TSI) のデプロイは、完了するまでに数分かかります。

1. Time Series Insights のデプロイが完了したら、ダッシュボードに戻ります。

1. リソース グループ タイルを更新し **tsi-az220-training**をクリックします。

    すべてのリソースを表示するには、ダッシュボードのサイズを変更する必要がある場合があります。

    > **注意**: **Time Series Insights 環境**リソースに **tsi-az220-training** という名前を付けました。  作成した *Time Series Insights イベント ソース*も表示されますが、ここでは TSI 環境を開く必要があります。   
 
1. 「**Time Series Insights 環境**」ブレードの左側のナビゲーション メニューで、「**設定**」の「**イベント ソース**>」をクリックします。     

1. 「**イベント ソース**」ウィンドウで、リスト内の **iot-az220-training-{your-id}** イベント ソースに注目してください。   

    これは、TSI リソースが作成されたときに設定されたイベント ソースです。

1. イベント ソースの詳細を表示するには 「**iot-az220-training-{your-id}**」をクリックします。 

    イベント ソースの構成が、Time Series Insights リソースの作成時に設定された設定と一致していることに注意してください。

### 演習 3: シミュレートされた IoT デバイスを実行する

この演習では、シミュレートされたデバイスを実行して、テレメトリ イベントを Azure IoT Hub に送信します。

1. **Visual Studio Code** を開きます。

1. ContainerSimulationフォルダを開きます。

    _ラボ 3: 開発環境のセットアップ_:ZIP ファイルをダウンロードしてコンテンツをローカルに抽出することで、ラボ リソースを含む GitHub リポジトリを複製しました。抽出されたフォルダー構造には、次のフォルダー パスが含まれます。

    * Allfiles
        * Labs
            * 10-Explore and analyze time stamped data with Time Series Insights
                * Starter
                    * ContainerSimulation

1. メッセージが表示されたら、C# 拡張機能を読み込み、復元を実行します。
 
1. 「Explorer」 ペインで、「**Program.cs**」 をクリックして 「Program.cs」 ファイルを開きます。

1. 接続文字列の割り当てに使用する変数を見つけます。

    ```csharp
    private readonly static string connectionString_Truck = "{Your Truck device connection string here}";
    private readonly static string connectionString_Airplane = "{Your Airplane device connection string here}";
    private readonly static string connectionString_Container = "{Your Container device connection string here}";
    ```

1. 変数の割り当てを、ラボで前に保存した接続文字列で更新します。 

    プレースホルダーの値を、対応する IoT デバイスの接続文字列に置き換えてください。

1. 「**ファイル**」 メニューの 「**上書き保存**」 をクリックします。   

1. **「表示」**メニューで、**「ターミナル」** をクリック します。   

1. **「ターミナル」** ペインで、コマンド プロンプトで lab 10 `/Starter/ContainerSimulation` ディレクトリへのパスを指定していることを確認します。 

1. コマンド プロンプトで、**ContainerSimulation** アプリをビルドして実行するには 、次のコマンドを入力します。 

    ```cmd/sh
    dotnet run
    ```

1. 「ターミナル」 ペインに表示されるメッセージに注意してください。

    **ContainerSimulation** アプリが実行されると、利用統計情報のターミナルへの出力が開始されます。  これは、Azure IoT Hub に送信する利用統計情報です。

    **ContainerSimulation** アプリが実行されている場合、 **「ターミナル」** 出力は次のようになります。   

    ```text
    12/27/2019 8:51:30 PM > Sending TRUCK message: {"temperature":35.15660452608195,"humidity":48.422323938240865}
    12/27/2019 8:51:31 PM > Sending AIRPLANE message: {"temperature":17.126545186374237,"humidity":36.46941012936869}
    12/27/2019 8:51:31 PM > Sending CONTAINER message: {"temperature":21.986403302500637,"humidity":47.847680384455096}
    12/27/2019 8:51:32 PM > Sending TRUCK message: {"temperature":36.10474464823629,"humidity":48.82029906486022}
    12/27/2019 8:51:32 PM > Sending AIRPLANE message: {"temperature":16.55005930170971,"humidity":36.49988437459935}
    12/27/2019 8:51:32 PM > Sending CONTAINER message: {"temperature":21.811727088543286,"humidity":50.0}
    ```

1. このラボの残りの期間は、 **ContainerSimulation** アプリを実行したままにします。 

    これにより、3 つのデバイス (コンテナー、トラック、および航空機) からのデバイスの製品利用統計情報が Azure IoT Hub に送信されます。

1. **ContainerSimulation** アプリが 30 秒間実行されると、**コンテナー** デバイスが配送方法を変更していることを示すメッセージが表示されます。

    配送方法は **トラック**および**航空機**の間で30秒ごとに変わります。  この場合、**「ターミナル」** 出力は次のようになります。

    ```text
    12/27/2019 8:51:40 PM > CONTAINER transport changed to: TRUCK
    ```

    > **注意**:  実稼働では、出荷コンテナーは通常の出荷過程での転送方法のみを変更します。このラボでシミュレートされたシナリオでは、このラボの手順実行中に収まる十分に短いデータ期間を提供するため、30 秒ごとに実行されます。

### 演習 4: Time Series Insights Explorer の表示

この演習では、Time Series Insights (TSI) Explorer を使用して時系列データを操作する方法について説明します。

1. 必要に応じて Azure アカウントの認証情報を使用し、[portal.azure.com](https://portal.azure.com) にログインします。

    複数の Azure アカウントをお持ちの場合は、このコースで使用するサブスクリプションに関連付けられているアカウントでログインしていることを確認してください。

1. リソース グループ タイルで、**tsi-az220-training** をクリックします。

1. 「**Time Series Insights 環境**」 ブレードの 「**概要**」 の最上部で、「**TSIエクスプローラーに移動**」 をクリックします。

    これにより、新しいブラウザー タブで 「**Time Series Insights Explorer**」 が開きます。

1. 左側のナビゲーション メニューで、「**分析**」 が選択されていることを確認します。

    ナビゲーション メニューを展開すると、ボタン名を表示できます。「分析」と「モデル」の 2 つのオプションがあります。「分析」 を選択します。

1. 左側に表示されている各デバイスIDをクリックし、「humidity」と「temperature」のチェックボックスをオンにします。


1. 3 つのシミュレートされたデバイスからシステムにストリーミングされるテレメトリの温度データ (グラフ) を確認します。

1. **sensor-th-container0001** の **temperature** のスパイクは、**sensor-th-truck0001** または **sensor-th-airplane0001** の温度スパイクと相関していることに注意してください。

    これにより、ContainerDevice がその時点でトラックまたは飛行機で輸送されていることがわかります。

1. グラフの線の上にマウス ポインタを置きます。

    グラフ上にマウス カーソルを置くと、グラフ上の点の詳細がポップアップに表示されます。ポップアップには、グラフ内のデータポイントの最小値 (**min**)、平均値 (**avg**)、および最大値 (**max**) が (そのポイントで表される短時間で) 表示されます。選択したデータ ポイントに関連付けられた時間の範囲が、ディスプレイ下部の時間軸に沿って表示されます。

1. 縦軸の上に、グラフ設定を制御するために使用できるオプションがある点に注目してください。

1. ビューを保存します。

データの探索が完了したら、 ターミナルで**Ctrl+C**キーを押してデバイス シミュレーター アプリを停止することを忘れないでください。
